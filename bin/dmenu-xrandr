#!/bin/sh

xrandr_output="$(xrandr)"
connected_monitors=$(printf "%s" "$xrandr_output" | grep "\\bconnected\\b" | awk '{print $1}')
disconnected_monitors=$(printf "%s" "$xrandr_output" | grep "\\bdisconnected\\b" | awk '{print $1}')

dmenu_cmd() {
  rofi -i -fuzzy -dmenu -p "$1"
}

resolution_options() {
  available_resolutions=$(printf "%s" "$xrandr_output" |
    awk -v monitor="^$1" '
      /connected/ {p = 0}
      $0 ~ monitor {p = 1}
      {if (p == 1) print $1}
    ' |
    tail --lines +2)
  printf "%s\\noff" "$available_resolutions"
}

# Turn disconnected monitors off.
for disconnected_monitor in $disconnected_monitors; do
  xrandr --output "$disconnected_monitor" --off
done

selected_monitor=$(printf "%s\\n" "$connected_monitors" | dmenu_cmd "Output")
[ -z "$selected_monitor" ] && exit

selected_resolution=$(printf "%s\\n" "$(resolution_options "$selected_monitor")" | dmenu_cmd "Mode")
[ -z "$selected_resolution" ] && exit

if [ "$selected_resolution" = "off" ]; then
  xrandr --output "$selected_monitor" --off
  exit
fi

selected_rotation=$(printf "normal\\ninverted\\nleft\\nright\\n" | dmenu_cmd "Rotation")
[ -z "$selected_rotation" ] && exit

anchor_options=$(printf "%s\\n" "$connected_monitors" | grep --invert-match "^$selected_monitor$")
if [ -z "$anchor_options" ]; then
  xrandr --output "$selected_monitor" --mode "$selected_resolution" --rotate "$selected_rotation"
  setup-polybar
  setup-background
  exit
fi
selected_anchor=$(printf "%s" "$anchor_options" | dmenu_cmd "Anchor")
[ -z "$selected_anchor" ] && exit

selected_position=$(printf "above\\nbelow\\nsame-as\\nleft-of\\nright-of\\n" | dmenu_cmd "Position")
[ -z "$selected_position" ] && exit

xrandr --output "$selected_monitor" --mode "$selected_resolution" --"$selected_position" "$selected_anchor" --rotate "$selected_rotation"
setup-polybar
setup-background
