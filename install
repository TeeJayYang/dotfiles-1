#!/usr/bin/env python

import os
import glob
import sys
import yaml
import argparse
import subprocess
import shlex

def readOptions () :
    parser = argparse.ArgumentParser(description="Installation script for dotfiles.")
    parser.add_argument("-d", dest="dir", metavar="folder",
        help="root directory of dotfiles")
    parser.add_argument("-c", dest="conf", metavar="file",
        help="config file for symlinking and installing")
    parser.add_argument("-p", dest="prompt", action="store_true",
        help="prompt user before installing package")
    parser.add_argument("-u", dest="update", action="store_true",
        help="only update symlinks")

    return parser.parse_args()

def expandPath (path) :
    if path == None:
        return None
    return os.path.abspath(os.path.expanduser(path))

if __name__ == "__main__":
    args = readOptions()
    dir = expandPath(args.dir) or os.path.dirname(os.path.realpath(__file__))
    conf = expandPath(args.conf) or os.path.join(dir, "config.yaml")

    stream = open(conf, "r")
    packages = yaml.load(stream)

    for package in packages:
        if args.prompt:
            if raw_input("\nInstall {} (Y/n)? ".format(package)).strip().lower() == "n":
                continue
        else:
            print "\nInstalling {}".format(package)

        linkLocations = []
        overwrite = True
        prelink = []
        postlink = []
        dependencies = []
        symlinkedFiles = set()

        if not 'link' in packages[package]:
            raise ValueError('No link attribute set.')
        elif isinstance(packages[package]['link'], list):
            linkLocations = packages[package]['link']
        else:
            linkLocations = [
                {"*": packages[package]['link']},
                {".*": packages[package]['link']}
            ]

        if 'overwrite' in packages[package]:
            overwrite = packages[package]['overwrite']

        if 'prelink' in packages[package]:
            prelink = packages[package]['prelink']

        if 'postlink' in packages[package]:
            postlink = packages[package]['postlink']

        if 'dependencies' in packages[package]:
            dependencies = packages[package]['dependencies']

        if not args.update:
            for script in prelink:
                subprocess.call([os.path.expanduser(token) for token in shlex.split(script)])
            for dependency in dependencies:
                subprocess.call(["sudo", "apt-get", "install", dependency])

        for linkLocation in linkLocations:
            for pattern, path in linkLocation.iteritems():
                location = expandPath(path)
                subprocess.call(["mkdir", "-pv", location])
                for filename in glob.iglob(os.path.join(dir, package, pattern)):
                    basename = os.path.basename(filename)
                    if basename in symlinkedFiles:
                        continue
                    symlinkedFiles.add(basename)

                    if overwrite:
                        subprocess.call(["rm", os.path.join(expandPath(location), basename)], stderr=open(os.devnull, 'wb'))
                        subprocess.call(["ln", "-sfv", filename, expandPath(location)])
                    else:
                        subprocess.call(["ln", "-sv", filename, expandPath(location)])

        if not args.update:
            for script in postlink:
                subprocess.call([os.path.expanduser(token) for token in shlex.split(script)])
